<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Session</title>
    <style>
      :root {
        --bg: #0f0f10;
        --panel: #0b0b0c;
        --text: #fff;
        --muted: #9c9c9c;
        --accent: #fff200;
        --outline: #2a2a2c;
      }
      body {
        background: var(--bg);
        color: var(--text);
        font-family: "Inter", sans-serif;
        margin: 0;
        padding: 0;
      }
      header {
        display: flex;
        align-items: center;
        padding: 1rem;
      }
      header button {
        background: none;
        border: none;
        color: var(--muted);
        font-size: 1.4rem;
        cursor: pointer;
      }
      .container {
        padding: 0 1.5rem 3rem;
      }
      .title {
        font-size: 1.9rem;
        font-weight: 800;
        text-transform: uppercase;
        margin-top: 0.5rem;
        line-height: 1.2;
      }
      .meta {
        display: flex;
        align-items: center;
        gap: 1.2rem;
        color: var(--muted);
        font-size: 0.9rem;
        margin: 0.5rem 0 1.5rem;
      }
      .desc {
        color: var(--muted);
        font-size: 1rem;
        margin-bottom: 2rem;
      }
      .start-btn {
        display: block;
        width: 100%;
        text-align: center;
        padding: 1.1rem;
        background-color: var(--accent);
        color: black;
        font-weight: 700;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        font-size: 1rem;
      }
      .panel {
        background-color: var(--panel);
        border-radius: 14px;
        margin-top: 2rem;
        padding: 1.2rem;
      }
      .panel h2 {
        font-size: 1.2rem;
        font-weight: 700;
        margin-bottom: 1rem;
      }
      .exercise {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.8rem 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      }
      .exercise:last-child {
        border-bottom: none;
      }
      .exercise-left {
        display: flex;
        align-items: center;
        gap: 0.8rem;
      }
      .exercise-num {
        font-weight: 800;
        color: var(--accent);
      }
      .exercise-name {
        font-weight: 600;
        font-size: 1rem;
      }
      .exercise-right {
        font-size: 0.9rem;
        color: var(--muted);
      }
      .workout-screen {
        display: none;
      }
      .exercise-box {
        background-color: var(--panel);
        border-radius: 14px;
        padding: 1.6rem;
        margin-bottom: 5.5rem;
        border: 1px solid #2a2a2c;
      }
      .set-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1rem;
        background: #111;
        border-radius: 12px;
        padding: 0.9rem;
      }
      .set-row span {
        font-weight: 500;
        width: 60px;
      }
      .input-box {
        width: 70px;
        text-align: center;
        background: #000;
        border: 1px solid var(--outline);
        border-radius: 8px;
        color: var(--text);
        font-weight: 600;
        padding: 0.3rem;
        outline: none;
        font-size: 1rem;
      }
      .input-box:focus {
        border-color: var(--accent);
      }
      .check-btn {
        width: 30px;
        height: 30px;
        border: 1.8px solid var(--accent);
        border-radius: 8px;
        background: transparent;
        color: var(--accent);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 1.1rem;
        transition: 0.2s;
      }
      .check-btn.done {
        background: var(--accent);
        color: #000;
        box-shadow: 0 0 8px var(--accent);
      }
      .footer-info {
        margin-top: 0.8rem;
        color: var(--muted);
        font-size: 0.85rem;
        border-top: 1px solid var(--outline);
        padding-top: 0.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
      }
      #historyModal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        justify-content: center;
        align-items: center;
      }
      #historyModal .modal-content {
        background: #222;
        padding: 1.5rem;
        border-radius: 12px;
        max-width: 600px;
        width: 90%;
        max-height: 80%;
        overflow-y: auto;
      }
      #historyModal table {
        width: 100%;
        border-collapse: collapse;
      }
      #historyModal th,
      #historyModal td {
        padding: 8px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        text-align: left;
      }
      #closeHistory {
        margin-top: 1rem;
        padding: 0.5rem 1rem;
        background: var(--accent);
        border: none;
        color: black;
        border-radius: 6px;
        cursor: pointer;
      }
      @media (max-width: 500px) {
        .set-row {
          flex-wrap: wrap;
          gap: 0.5rem;
        }
      }
    </style>
    <style>
      /* emom */
      /* ----- EMOM SCREEN ----- */
      .emom-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #0b0b0c;
        color: #fff;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
        z-index: 9999;
        text-align: center;
      }

      .emom-screen h2 {
        font-size: 2rem;
        margin-bottom: 1.5rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: var(--accent);
      }

      /* EXERCISE LIST */
      #emomExerciseList {
        margin-bottom: 2rem;
        max-height: 200px;
        overflow-y: auto;
        text-align: left;
        width: 100%;
        max-width: 400px;
      }

      #emomExerciseList div {
        margin: 6px 0;
        font-size: 1.1rem;
        padding: 6px 12px;
        background: #111;
        border-radius: 8px;
        border: 1px solid #222;
      }

      /* CIRCLE TIMER CONTAINER */
      .emom-timer-container {
        position: relative;
        width: 180px;
        height: 180px;
        margin-bottom: 1.5rem;
      }

      .emom-timer-container svg {
        transform: rotate(-90deg);
        width: 100%;
        height: 100%;
      }

      .emom-timer-container circle {
        fill: none;
        stroke-width: 12;
        stroke-linecap: round;
      }

      .emom-timer-bg {
        stroke: #222;
      }

      .emom-timer-progress {
        stroke: var(--accent);
        stroke-dasharray: 565.48;
        stroke-dashoffset: 565.48;
        transition: stroke-dashoffset 0.1s linear;
      }

      /* TIMER TEXT */
      #emomTimerText {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 2rem;
        font-weight: 700;
        color: var(--accent);
      }

      /* INPUTS FOR DURATION & ROUNDS */
      .emom-inputs {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
      }

      .emom-inputs input {
        width: 100px;
        padding: 0.5rem 0.8rem;
        border-radius: 8px;
        border: 1px solid #333;
        background: #111;
        color: #fff;
        font-weight: 600;
        text-align: center;
      }

      .emom-inputs input:focus {
        border-color: var(--accent);
        outline: none;
      }

      /* BUTTONS */
      .emom-screen button {
        margin: 8px 6px;
        padding: 0.8rem 1.5rem;
        border: none;
        border-radius: 10px;
        background: var(--accent);
        color: #000;
        font-weight: 700;
        cursor: pointer;
        font-size: 1rem;
        transition: 0.2s;
      }

      .emom-screen button:hover {
        background: #fff200cc;
      }

      /* SCROLLBAR FOR EXERCISE LIST */
      #emomExerciseList::-webkit-scrollbar {
        width: 6px;
      }

      #emomExerciseList::-webkit-scrollbar-track {
        background: #111;
      }

      #emomExerciseList::-webkit-scrollbar-thumb {
        background: var(--accent);
        border-radius: 3px;
      }

      /* RESPONSIVE */
      @media (max-width: 500px) {
        .emom-timer-container {
          width: 140px;
          height: 140px;
        }

        .emom-inputs input {
          width: 80px;
        }

        #emomTimerText {
          font-size: 1.6rem;
        }
      }
    </style>
  </head>
  <body>
    <!-- SCREEN 1 -->
    <div id="sessionScreen">
      <header><button onclick="window.history.back()">←</button></header>
      <div class="container">
        <h1 class="title" id="sessionTitle">Loading...</h1>
        <div class="meta" id="sessionMeta"></div>
        <p class="desc" id="sessionDesc"></p>
        <button class="start-btn" id="startWorkoutBtn">▶ Start Workout</button>
        <div class="panel">
          <h2>Workout Overview</h2>
          <div id="exerciseList"></div>
        </div>
      </div>
    </div>

    <!-- SCREEN 2 -->
    <div id="workoutScreen" class="workout-screen">
      <header><button id="backBtn">←</button></header>
      <div class="container">
        <h1 class="title" id="workoutTitle">Workout</h1>
        <p style="color: var(--muted); font-size: 1rem; margin-bottom: 1rem">
          Timer: <span id="workoutTimer">00:00</span>
        </p>
        <div id="exercisesContainer"></div>

        <!-- EMOM Overlay -->
        <div id="emomScreen" class="emom-screen" style="display: none">
          <h2>EMOM Workout</h2>

          <div style="margin-bottom: 15px">
            <label
              >Round duration (seconds):
              <input
                type="number"
                id="emomDuration"
                value="60"
                min="10"
                style="width: 60px"
            /></label>
            <label
              >Number of rounds:
              <input
                type="number"
                id="emomRounds"
                value="5"
                min="1"
                style="width: 60px"
            /></label>
          </div>

          <div id="emomExerciseList" style="margin-bottom: 20px"></div>

          <!-- Circular timer -->
          <div
            style="
              position: relative;
              width: 200px;
              height: 200px;
              margin: 0 auto 20px;
            "
          >
            <svg width="200" height="200">
              <circle
                cx="100"
                cy="100"
                r="90"
                stroke="#333"
                stroke-width="15"
                fill="none"
              ></circle>
              <circle
                id="emomCircle"
                cx="100"
                cy="100"
                r="90"
                stroke="#fff200"
                stroke-width="15"
                fill="none"
                stroke-dasharray="565.48"
                stroke-dashoffset="565.48"
                transform="rotate(-90 100 100)"
              ></circle>
            </svg>
            <div
              id="emomTimerText"
              style="
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                font-size: 2rem;
                font-weight: 700;
              "
            >
              00:00
            </div>
          </div>

          <button id="startEmom">Start EMOM</button>
          <button id="exitEmom">Exit EMOM</button>
        </div>

        <!-- Finish Screen -->

        <button
          id="finishBtn"
          class="start-btn"
          style="flex: 1; background: #fff200"
        >
          Finish workout
        </button>
      </div>
    </div>

    <!-- HISTORY MODAL -->
    <div id="historyModal">
      <div class="modal-content">
        <h2 id="historyTitle">History</h2>
        <table id="historyTable">
          <thead>
            <tr>
              <th>Date</th>
              <th>Workout</th>
              <th>Weight</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <button id="closeHistory">Close</button>
      </div>
    </div>
    <script>
      // ----- CONFIG -----
      const hasEMOM = true; // Admin enables EMOM

      // ----- ELEMENTS -----
      const sessionScreen = document.getElementById("sessionScreen");
      const workoutScreen = document.getElementById("workoutScreen");
      const startWorkoutBtn = document.getElementById("startWorkoutBtn");
      const backBtn = document.getElementById("backBtn");
      const exerciseList = document.getElementById("exerciseList");
      const exercisesContainer = document.getElementById("exercisesContainer");
      const timerDisplay = document.getElementById("workoutTimer");
      const finishBtn = document.getElementById("finishBtn");

      // HISTORY MODAL
      const historyModal = document.getElementById("historyModal");
      const historyTableBody = document.querySelector("#historyTable tbody");
      const historyTitle = document.getElementById("historyTitle");
      const closeHistory = document.getElementById("closeHistory");

      // EMOM OVERLAY ELEMENTS
      const emomScreen = document.getElementById("emomScreen");
      const emomExerciseList = document.getElementById("emomExerciseList");
      const emomCircle = document.getElementById("emomCircle");
      const emomTimerText = document.getElementById("emomTimerText");
      const emomStartBtn = document.getElementById("startEmom");
      const emomExitBtn = document.getElementById("exitEmom");
      const emomDurationInput = document.getElementById("emomDuration");
      const emomRoundsInput = document.getElementById("emomRounds");

      let emomInterval; // EMOM timer interval

      // ----- LOAD WORKOUT -----
      let workout = JSON.parse(
        sessionStorage.getItem("selectedWorkout") || "{}"
      );
      if (!workout.details) {
        alert("No workout selected!");
        window.location.href = "workouts.html";
      }

      document.getElementById("sessionTitle").textContent =
        workout.name || "Workout Session";
      document.getElementById("sessionMeta").textContent = `${
        workout.day || ""
      } • ${workout.time || ""}`;
      document.getElementById("sessionDesc").textContent =
        workout.encouragement || "";

      // ----- PROCESS EXERCISES -----
      const exerciseLines = workout.details.split("\n").filter((l) => l.trim());
      const strengthExercises = [];
      const cardioExercises = [];
      exerciseLines.forEach((line) => {
        if (
          line.toLowerCase().includes("cardio") ||
          line.toLowerCase().includes("emom")
        ) {
          cardioExercises.push(line);
        } else {
          strengthExercises.push(line);
        }
      });
      const allExercisesOrdered = [...strengthExercises, ...cardioExercises];

      // ----- OVERVIEW -----
      exerciseList.innerHTML = "";
      allExercisesOrdered.forEach((line, i) => {
        const div = document.createElement("div");
        div.className = "exercise";
        div.innerHTML = `<div class="exercise-left"><span class="exercise-num">${String(
          i + 1
        ).padStart(
          2,
          "0"
        )}</span><span class="exercise-name">${line}</span></div><div class="exercise-right">—</div>`;
        exerciseList.appendChild(div);
      });

      // ----- HELPERS -----
      function getSuggestedWeight(name) {
        const completed = JSON.parse(
          localStorage.getItem("completedWorkouts") || "[]"
        );
        for (let i = completed.length - 1; i >= 0; i--) {
          const ex = completed[i].exercises.find((e) => e.name === name);
          if (ex && ex.weight) return ex.weight;
        }
        return "";
      }

      // ----- TIMER -----
      let timerInterval;
      let startTime =
        parseInt(localStorage.getItem("workoutStartTime")) ||
        Date.now() -
          (parseInt(localStorage.getItem("workoutSeconds")) || 0) * 1000;
      function startTimer() {
        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
          const sec = Math.floor((Date.now() - startTime) / 1000);
          localStorage.setItem("workoutSeconds", sec);
          const mins = String(Math.floor(sec / 60)).padStart(2, "0");
          const secs = String(sec % 60).padStart(2, "0");
          timerDisplay.textContent = `${mins}:${secs}`;
        }, 1000);
      }

      // ----- LOAD WORKOUT SCREEN -----
      function loadWorkout() {
        exercisesContainer.innerHTML = "";

        // Merge consecutive cardio/EMOM into blocks
        const merged = [];
        let block = [];
        allExercisesOrdered.forEach((line) => {
          if (
            line.toLowerCase().includes("cardio") ||
            line.toLowerCase().includes("emom")
          ) {
            block.push(line);
          } else {
            if (block.length) {
              merged.push({
                name: "Cardio / EMOM Block",
                items: [...block],
                isCardio: true,
              });
              block = [];
            }
            merged.push({ name: line, isCardio: false });
          }
        });
        if (block.length)
          merged.push({
            name: "Cardio / EMOM Block",
            items: [...block],
            isCardio: true,
          });

        merged.forEach((ex, exIndex) => {
          const sets = ex.isCardio ? 1 : 3;
          const saved = JSON.parse(
            localStorage.getItem(
              "currentWorkout_" + workout.name + "_" + exIndex
            ) || "{}"
          );
          const box = document.createElement("div");
          box.className = "exercise-box";

          if (ex.isCardio && hasEMOM) {
            // Cardio/EMOM block
            box.innerHTML = `
        <h3>${ex.items.join(" / ")}</h3>
        <button class="start-btn" id="startBlockEMOM${exIndex}">Start EMOM</button>
      `;
            const startBlockBtn = box.querySelector(
              `#startBlockEMOM${exIndex}`
            );
            startBlockBtn.addEventListener("click", () => openEMOM(ex.items));
          } else if (!ex.isCardio) {
            // Strength
            box.innerHTML = `<h3>${ex.name}</h3>`;
            for (let i = 1; i <= sets; i++) {
              const suggested = getSuggestedWeight(ex.name);
              const setDiv = document.createElement("div");
              setDiv.className = "set-row";
              setDiv.innerHTML = `
          <span>Set ${i}</span>
          <input type="number" class="input-box" placeholder="kg" value="${
            saved[`weight_${i}`] || suggested
          }" data-field="weight_${i}">
          <input type="number" class="input-box" placeholder="reps" value="${
            saved[`reps_${i}`] || ""
          }" data-field="reps_${i}">
          <button class="check-btn ${
            saved[`done_${i}`] ? "done" : ""
          }">✓</button>
        `;
              box.appendChild(setDiv);
            }
          }

          // Footer
          const footer = document.createElement("div");
          footer.className = "footer-info";
          footer.innerHTML = `<span>${
            ex.isCardio
              ? "Cardio / EMOM session"
              : "Suggested weight based on history"
          }</span><span>View History</span>`;
          box.appendChild(footer);

          exercisesContainer.appendChild(box);

          // Strength inputs
          if (!ex.isCardio) {
            const inputs = box.querySelectorAll(".input-box");
            const buttons = box.querySelectorAll(".check-btn");
            const viewHistoryBtn = footer.querySelector("span:last-child");
            inputs.forEach((input) =>
              input.addEventListener("input", () => saveExercise(exIndex, box))
            );
            buttons.forEach((btn) =>
              btn.addEventListener("click", () => {
                btn.classList.toggle("done");
                saveExercise(exIndex, box);
              })
            );
            viewHistoryBtn.addEventListener("click", () =>
              showHistory(ex.name)
            );
          }
        });

        localStorage.setItem("workoutStartTime", startTime);
        startTimer();
      }

      // ----- SAVE EXERCISE -----
      function saveExercise(exIndex, box) {
        const data = {};
        box
          .querySelectorAll(".input-box")
          .forEach((input) => (data[input.dataset.field] = input.value));
        box
          .querySelectorAll(".check-btn")
          .forEach(
            (btn, i) => (data[`done_${i + 1}`] = btn.classList.contains("done"))
          );
        localStorage.setItem(
          "currentWorkout_" + workout.name + "_" + exIndex,
          JSON.stringify(data)
        );
      }

      // ----- SHOW HISTORY -----
      function showHistory(exName) {
        historyTitle.textContent = `History for: ${exName}`;
        historyTableBody.innerHTML = "";
        const completedWorkouts = JSON.parse(
          localStorage.getItem("completedWorkouts") || "[]"
        );
        completedWorkouts.reverse().forEach((w) => {
          const ex = w.exercises.find((e) => e.name === exName);
          if (ex) {
            const tr = document.createElement("tr");
            tr.innerHTML = `<td>${new Date(
              w.date
            ).toLocaleDateString()}</td><td>${w.name}</td><td>${
              ex.weight || "—"
            }</td>`;
            historyTableBody.appendChild(tr);
          }
        });
        historyModal.style.display = "flex";
      }
      closeHistory.addEventListener(
        "click",
        () => (historyModal.style.display = "none")
      );

      // ----- EMOM OVERLAY -----
      function openEMOM(exercises) {
        emomExerciseList.innerHTML = "";
        exercises.forEach((ex, i) => {
          const div = document.createElement("div");
          div.textContent = `${i + 1}. ${ex}`;
          emomExerciseList.appendChild(div);
        });
        emomScreen.style.display = "flex";
        resetEMOM();
      }

      function resetEMOM() {
        clearInterval(emomInterval);
        emomCircle.style.strokeDashoffset = 565.48;
        emomTimerText.textContent = "00:00";
      }

      emomStartBtn.onclick = () => {
        const roundDuration = parseInt(emomDurationInput.value) || 60;
        const rounds = parseInt(emomRoundsInput.value) || 5;
        let currentRound = 1;
        let elapsed = 0;
        const totalOffset = 565.48;
        emomCircle.style.strokeDashoffset = totalOffset;

        clearInterval(emomInterval);
        const startTime = Date.now();

        emomInterval = requestAnimationFrame(function update() {
          const now = Date.now();
          elapsed = Math.floor((now - startTime) / 1000);
          const progress =
            (((now - startTime) / 1000) % roundDuration) / roundDuration;
          emomCircle.style.strokeDashoffset = totalOffset * (1 - progress);
          const remaining =
            roundDuration -
            Math.floor(((now - startTime) / 1000) % roundDuration);
          emomTimerText.textContent = `${String(
            Math.floor(remaining / 60)
          ).padStart(2, "0")}:${String(remaining % 60).padStart(2, "0")}`;

          if (elapsed >= roundDuration * rounds) {
            emomTimerText.textContent = "Done!";
            emomCircle.style.strokeDashoffset = 0;
            return;
          }
          requestAnimationFrame(update);
        });
      };

      emomExitBtn.onclick = () => {
        clearInterval(emomInterval);
        emomScreen.style.display = "none";
        emomCircle.style.strokeDashoffset = 565.48;
        emomTimerText.textContent = "00:00";
      };

      // ----- BUTTONS -----
      startWorkoutBtn.addEventListener("click", () => {
        sessionScreen.style.display = "none";
        workoutScreen.style.display = "block";
        loadWorkout();
      });

      backBtn.addEventListener("click", () => {
        workoutScreen.style.display = "none";
        sessionScreen.style.display = "block";
      });

      finishBtn.addEventListener("click", () => {
        const completedWorkout = {
          name: workout.name,
          day: workout.day,
          time: workout.time,
          encouragement: workout.encouragement,
          date: new Date().toISOString(),
          duration: parseInt(localStorage.getItem("workoutSeconds")) || 0,
          exercises: [],
        };
        const boxes = exercisesContainer.children;
        for (let i = 0; i < boxes.length; i++) {
          const box = boxes[i];
          const title = box.querySelector("h3").textContent;
          const weightInputs = box.querySelectorAll(
            'input[data-field^="weight_"]'
          );
          const weight = weightInputs.length > 0 ? weightInputs[0].value : "";
          completedWorkout.exercises.push({ name: title, weight });
          localStorage.removeItem("currentWorkout_" + workout.name + "_" + i);
        }
        const allCompleted = JSON.parse(
          localStorage.getItem("completedWorkouts") || "[]"
        );
        allCompleted.push(completedWorkout);
        localStorage.setItem("completedWorkouts", JSON.stringify(allCompleted));

        clearInterval(timerInterval);
        localStorage.removeItem("workoutSeconds");
        localStorage.removeItem("workoutStartTime");

        workoutScreen.style.display = "none";
        sessionScreen.style.display = "block";
      });

      // ----- AUTO RESUME -----
      const anySaved = Array.from({ length: allExercisesOrdered.length }).some(
        (_, i) =>
          localStorage.getItem("currentWorkout_" + workout.name + "_" + i)
      );
      if (anySaved) {
        sessionScreen.style.display = "none";
        workoutScreen.style.display = "block";
        loadWorkout();
      }
    </script>
  </body>
</html>


