<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Session</title>
    <style>
      :root {
        --bg: #0f0f10;
        --panel: #0b0b0c;
        --text: #fff;
        --muted: #9c9c9c;
        --accent: #e2e2e2;
        --outline: #2a2a2c;
        --rest: #1a1a1a;
      }
      body {
        background: var(--bg);
        color: var(--text);
        font-family: "Inter", sans-serif;
        margin: 0;
        padding: 0;
        transition: background 0.3s, color 0.3s;
      }
      header {
        display: flex;
        align-items: center;
        padding: 1rem;
      }
      header button {
        background: none;
        border: none;
        color: var(--muted);
        font-size: 1.4rem;
        cursor: pointer;
      }
      .container {
        padding: 0 1.5rem 3rem;
      }
      .title {
        font-size: 1.9rem;
        font-weight: 800;
        text-transform: uppercase;
        margin-top: 0.5rem;
        line-height: 1.2;
      }
      .meta {
        display: flex;
        align-items: center;
        gap: 1.2rem;
        color: var(--muted);
        font-size: 0.9rem;
        margin: 0.5rem 0 1.5rem;
      }
      .desc {
        color: var(--muted);
        font-size: 1rem;
        margin-bottom: 2rem;
      }
      .start-btn {
        display: block;
        width: 100%;
        text-align: center;
        padding: 1.1rem;
        background-color: var(--accent);
        color: black;
        font-weight: 700;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        font-size: 1rem;
      }
      .panel {
        background-color: var(--panel);
        border-radius: 14px;
        margin-top: 2rem;
        padding: 1.2rem;
      }
      .exercise {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.8rem 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      }
      .exercise:last-child {
        border-bottom: none;
      }
      .exercise-left {
        display: flex;
        align-items: center;
        gap: 0.8rem;
      }
      .exercise-num {
        font-weight: 800;
        color: var(--accent);
      }
      .exercise-name {
        font-weight: 600;
        font-size: 1rem;
      }
      .exercise-right {
        font-size: 0.9rem;
        color: var(--muted);
      }
      .workout-screen {
        display: none;
      }
      .exercise-box {
        background-color: var(--panel);
        border-radius: 14px;
        padding: 1.6rem;
        margin-bottom: 5.5rem;
        border: 1px solid #2a2a2c;
      }
      .set-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1rem;
        background: #111;
        border-radius: 12px;
        padding: 0.9rem;
      }
      .set-row span {
        font-weight: 500;
        width: 60px;
      }
      .input-box {
        width: 70px;
        text-align: center;
        background: #000;
        border: 1px solid var(--outline);
        border-radius: 8px;
        color: var(--text);
        font-weight: 600;
        padding: 0.3rem;
        outline: none;
        font-size: 1rem;
      }
      .check-btn {
        width: 30px;
        height: 30px;
        border: 1.8px solid var(--accent);
        border-radius: 8px;
        background: transparent;
        color: var(--accent);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 1.1rem;
        transition: 0.2s;
      }
      .check-btn.done {
        background: var(--accent);
        color: #000;
        box-shadow: 0 0 8px var(--accent);
      }
      .footer-info {
        margin-top: 0.8rem;
        color: var(--muted);
        font-size: 0.85rem;
        border-top: 1px solid var(--outline);
        padding-top: 0.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      /* --- EMOM Overlay --- */
      #emomOverlay {
        display: none;
        position: fixed;
        inset: 0;
        background: var(--bg);
        color: var(--text);
        z-index: 100;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        transition: background 0.3s;
      }
      #emomOverlay h1 {
        font-size: 2rem;
        font-weight: 800;
        margin-bottom: 1rem;
      }
      #emomTimer {
        font-size: 5rem;
        font-weight: 900;
        margin-bottom: 1rem;
      }
      #emomRound {
        font-size: 1.3rem;
        margin-bottom: 2rem;
      }
      .emom-controls {
        display: flex;
        gap: 1rem;
      }
      .emom-controls button {
        background: var(--accent);
        color: #000;
        font-weight: 700;
        border: none;
        border-radius: 12px;
        padding: 0.9rem 1.4rem;
        font-size: 1rem;
        cursor: pointer;
        transition: 0.2s;
      }
    </style>
  </head>
  <body>
    <div id="sessionScreen">
      <header><button onclick="window.history.back()">←</button></header>
      <div class="container">
        <h1 class="title" id="sessionTitle">Loading...</h1>
        <div class="meta" id="sessionMeta"></div>
        <p class="desc" id="sessionDesc"></p>
        <button class="start-btn" id="startWorkoutBtn">▶ Start Workout</button>
        <div class="panel">
          <h2>Workout Overview</h2>
          <div id="exerciseList"></div>
        </div>
      </div>
    </div>

    <div id="workoutScreen" class="workout-screen">
      <header><button id="backBtn">←</button></header>
      <div class="container">
        <h1 class="title" id="workoutTitle">Workout</h1>
        <p style="color: var(--muted); font-size: 1rem; margin-bottom: 1rem">
          Timer: <span id="workoutTimer">00:00</span>
        </p>
        <div id="exercisesContainer"></div>
        <button id="finishBtn" class="start-btn">Finish workout</button>
      </div>
    </div>

    <!-- EMOM Overlay -->
    <div id="emomOverlay">
      <h1>EMOM</h1>
      <div id="emomTimer">00:00</div>
      <div id="emomRound">Round 1</div>
      <div class="emom-controls">
        <button id="pauseEMOM">Pause</button>
        <button id="resetEMOM">Reset</button>
        <button id="exitEMOM">Exit</button>
      </div>
    </div>

    <audio
      id="beep"
      src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"
    ></audio>

    <script>
      const sessionScreen = document.getElementById("sessionScreen");
      const workoutScreen = document.getElementById("workoutScreen");
      const startWorkoutBtn = document.getElementById("startWorkoutBtn");
      const backBtn = document.getElementById("backBtn");
      const exerciseList = document.getElementById("exerciseList");
      const exercisesContainer = document.getElementById("exercisesContainer");
      const timerDisplay = document.getElementById("workoutTimer");

      const emomOverlay = document.getElementById("emomOverlay");
      const emomTimer = document.getElementById("emomTimer");
      const emomRound = document.getElementById("emomRound");
      const pauseEMOM = document.getElementById("pauseEMOM");
      const resetEMOM = document.getElementById("resetEMOM");
      const exitEMOM = document.getElementById("exitEMOM");
      const beep = document.getElementById("beep");

      let timerInterval, startTime;
      let emomInterval,
        rounds,
        work,
        rest,
        currentRound,
        timeLeft,
        phase,
        running;

      // --- Load workout ---
      let workout = JSON.parse(
        sessionStorage.getItem("selectedWorkout") || "{}"
      );
      if (!workout.details) {
        alert("No workout selected!");
        window.location.href = "workouts.html";
      }
      document.getElementById("sessionTitle").textContent =
        workout.name || "Workout Session";
      document.getElementById("sessionMeta").textContent = `${
        workout.day || ""
      } • ${workout.time || ""}`;
      document.getElementById("sessionDesc").textContent =
        workout.encouragement || "";

      const lines = workout.details.split("\n").filter((l) => l.trim());
      const exercises = lines.map((l) => {
        const low = l.toLowerCase();
        if (low.startsWith("emom")) {
          const match = l.match(/emom (\d+) ?min/i);
          const emomRounds = match ? parseInt(match[1]) : 10;
          return {
            name: l,
            type: "EMOM",
            rounds: emomRounds,
            work: 60,
            rest: 0,
          };
        }
        if (low.includes("amrap")) return { name: l, type: "AMRAP" };
        if (
          low.includes("cardio") ||
          low.includes("metcon") ||
          low.includes("condition")
        )
          return { name: l, type: "CONDITIONING" };
        return { name: l, type: "STRENGTH" };
      });

      exerciseList.innerHTML = exercises
        .map(
          (e, i) =>
            `<div class="exercise">
          <div class="exercise-left">
            <span class="exercise-num">${String(i + 1).padStart(2, "0")}</span>
            <span class="exercise-name">${e.name}</span>
          </div>
          <div class="exercise-right">${e.type}</div>
        </div>`
        )
        .join("");

      function startTimer() {
        clearInterval(timerInterval);
        startTime = Date.now();
        timerInterval = setInterval(() => {
          const sec = Math.floor((Date.now() - startTime) / 1000);
          const m = String(Math.floor(sec / 60)).padStart(2, "0");
          const s = String(sec % 60).padStart(2, "0");
          timerDisplay.textContent = `${m}:${s}`;
        }, 1000);
      }

      function loadWorkout() {
        exercisesContainer.innerHTML = "";
        exercises.forEach((ex) => {
          const box = document.createElement("div");
          box.className = "exercise-box";

          if (ex.type === "EMOM") {
            box.innerHTML = `<h3>${ex.name}</h3>
              <button class="start-btn start-emom">Start EMOM</button>`;
            box.querySelector(".start-emom").onclick = () => openEMOM(ex);
          } else if (ex.type === "AMRAP") {
            box.innerHTML = `<h3>${ex.name}</h3>
              <div class="set-row"><span>AMRAP</span>
              <input type="number" class="input-box" placeholder="reps"></div>`;
          } else if (ex.type === "STRENGTH") {
            const setsCount = parseInt(workout.sets) || 4;
            box.innerHTML = `<h3>${ex.name}</h3>`;
            for (let i = 1; i <= setsCount; i++) {
              box.innerHTML += `<div class="set-row">
                <span>Set ${i}</span>
                <input type="number" class="input-box" placeholder="kg">
                <input type="number" class="input-box" placeholder="reps">
                <button class="check-btn">✓</button>
              </div>`;
            }
          } else {
            box.innerHTML = `<h3>${ex.name}</h3>
              <p style="color:var(--muted)">Follow conditioning instructions / timer</p>`;
          }

          exercisesContainer.appendChild(box);
        });

        // --- Check button logic ---
        document.querySelectorAll(".check-btn").forEach((btn) => {
          btn.onclick = () => btn.classList.toggle("done");
        });

        startTimer();
      }

      startWorkoutBtn.onclick = () => {
        sessionScreen.style.display = "none";
        workoutScreen.style.display = "block";
        loadWorkout();
      };
      backBtn.onclick = () => {
        workoutScreen.style.display = "none";
        sessionScreen.style.display = "block";
      };

      // --- Finish button like old design ---
      const finishBtn = document.getElementById("finishBtn");
      finishBtn.onclick = () => {
        clearInterval(timerInterval);
        alert("Workout finished! Great job!");
        workoutScreen.style.display = "none";
        sessionScreen.style.display = "block";
      };

      // --- EMOM logic ---
      function openEMOM(ex) {
        emomOverlay.style.display = "flex";
        rounds = ex.rounds;
        work = ex.work;
        rest = ex.rest;
        currentRound = 1;
        phase = "work";
        timeLeft = work;
        updateEMOMDisplay();
        startEMOM();
      }

      function updateEMOMDisplay() {
        const mins = String(Math.floor(timeLeft / 60)).padStart(2, "0");
        const secs = String(timeLeft % 60).padStart(2, "0");
        emomTimer.textContent = `${mins}:${secs}`;
        emomRound.textContent = `Round ${currentRound}/${rounds} — ${phase.toUpperCase()}`;
        document.body.style.background =
          phase === "work" ? "var(--accent)" : "var(--rest)";
        document.body.style.color = phase === "work" ? "#000" : "#fff";
      }

      function startEMOM() {
        running = true;
        clearInterval(emomInterval);
        emomInterval = setInterval(() => {
          if (timeLeft <= 0) {
            beep.play();
            if (phase === "work") {
              phase = "rest";
              timeLeft = rest;
            } else {
              if (currentRound < rounds) {
                currentRound++;
                phase = "work";
                timeLeft = work;
              } else {
                clearInterval(emomInterval);
                emomOverlay.style.display = "none";
                document.body.style.background = "var(--bg)";
                document.body.style.color = "var(--text)";
                return;
              }
            }
          } else timeLeft--;
          updateEMOMDisplay();
        }, 1000);
      }

      pauseEMOM.onclick = () => {
        if (running) {
          clearInterval(emomInterval);
          running = false;
          pauseEMOM.textContent = "Resume";
        } else {
          running = true;
          pauseEMOM.textContent = "Pause";
          startEMOM();
        }
      };
      resetEMOM.onclick = () => {
        clearInterval(emomInterval);
        currentRound = 1;
        phase = "work";
        timeLeft = work;
        updateEMOMDisplay();
        startEMOM();
      };
      exitEMOM.onclick = () => {
        clearInterval(emomInterval);
        emomOverlay.style.display = "none";
        document.body.style.background = "var(--bg)";
        document.body.style.color = "var(--text)";
      };
    </script>
  </body>
</html>
